C51 COMPILER V9.59.0.0   EEPROM                                                            02/08/2021 11:45:00 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE EEPROM
OBJECT MODULE PLACED IN .\Out_File\eeprom.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\Device\eeprom.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Device;..\Li
                    -braries) DEBUG OBJECTEXTEND PRINT(.\eeprom.lst) TABS(2) OBJECT(.\Out_File\eeprom.obj)

line level    source

   1          
   2          /*************  æŠ€æœ¯æ”¯æŒä¸è´­ä¹°è¯´æ˜    **************
   3          äº§å“ä¸»é¡µï¼šhttp://tw51.haohaodada.com
   4          æ·˜å®æœç´¢ï¼šå¤©é—®51ï¼Œå¯è´­ä¹°ã€‚ç›®å‰åŸºç¡€ç‰ˆ99å…ƒï¼Œå¸¦å½©å±æ ‡å‡†å¤‡ç‰ˆ149å…ƒ
   5          æŠ€æœ¯æ”¯æŒQQç¾¤ä¸€ï¼š1138055784
   6          ******************************************/
   7          
   8          #include "eeprom.h"
   9          #include "sys.h"
  10          #include "intrins.h"
  11          
  12          //========================================================================
  13          // æè¿°: ç¦æ­¢EEPROM.
  14          // å‚æ•°: none.
  15          // è¿”å›: none.
  16          //========================================================================
  17          void eeprom_disable(void)        //ç¦æ­¢è®¿é—®EEPROM
  18          {
  19   1          IAP_CONTR = 0;          //å…³é—­ IAP åŠŸèƒ½
  20   1          IAP_CMD = 0;            //æ¸…é™¤å‘½ä»¤å¯„å­˜å™¨
  21   1          IAP_TRIG = 0;           //æ¸…é™¤è§¦å‘å¯„å­˜å™¨
  22   1          IAP_ADDRH = 0xff;       //å°†åœ°å€è®¾ç½®åˆ°é IAP åŒºåŸŸ
  23   1          IAP_ADDRL = 0xff;
  24   1      }
  25          
  26          //========================================================================
  27          // æè¿°: è§¦å‘EEPROMæ“ä½œ.
  28          // å‚æ•°: none.
  29          // è¿”å›: none.
  30          //========================================================================
  31          void eeprom_trig(void)
  32          {
  33   1          F0 = EA;    //ä¿å­˜å…¨å±€ä¸­æ–­
  34   1          EA = 0;     //ç¦æ­¢ä¸­æ–­, é¿å…è§¦å‘å‘½ä»¤æ— æ•ˆ
  35   1          IAP_TRIG = 0x5A;
  36   1          IAP_TRIG = 0xA5;                    //å…ˆé€5AHï¼Œå†é€A5Håˆ°IAPè§¦å‘å¯„å­˜å™¨ï¼Œæ¯æ¬¡éƒ½éœ€è¦å¦‚æ
             -­¤
  37   1                                              //é€å®ŒA5Håï¼ŒIAPå‘½ä»¤ç«‹å³è¢«è§¦å‘å¯åŠ¨
  38   1                                              //CPUç­‰å¾…IAPå®Œæˆåï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œç¨‹åºã€‚
  39   1          _nop_();
  40   1          _nop_();
  41   1          EA = F0;    //æ¢å¤å…¨å±€ä¸­æ–­
  42   1      }
  43          
  44          //========================================================================
  45          // æè¿°: æ“¦é™¤ä¸€ä¸ªæ‰‡åŒº.
  46          // å‚æ•°: EE_address:  è¦æ“¦é™¤çš„EEPROMçš„æ‰‡åŒºä¸­çš„ä¸€ä¸ªå­—èŠ‚åœ°å€.
  47          // è¿”å›: none.
  48          //========================================================================
  49          void eeprom_sector_erase(uint16 EE_address)
  50          {
  51   1          EEPROM_IAP_ENABLE();                       //è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œå…è®¸IAPæ“ä½œï¼Œé€ä¸€æ¬¡å°±å¤Ÿ
  52   1          EEPROM_IAP_ERASE();                        //å®è°ƒç”¨, é€æ‰‡åŒºæ“¦é™¤å‘½ä»¤ï¼Œå‘½ä»¤ä¸éœ€æ”¹å˜æ—¶ï
             -¼Œä¸éœ€é‡æ–°é€å‘½ä»¤
C51 COMPILER V9.59.0.0   EEPROM                                                            02/08/2021 11:45:00 PAGE 2   

  53   1                                              //åªæœ‰æ‰‡åŒºæ“¦é™¤ï¼Œæ²¡æœ‰å­—èŠ‚æ“¦é™¤ï¼Œ512å­—èŠ‚/æ‰‡åŒºã€‚
  54   1                                              //æ‰‡åŒºä¸­ä»»æ„ä¸€ä¸ªå­—èŠ‚åœ°å€éƒ½æ˜¯æ‰‡åŒºåœ°å€ã€‚
  55   1          IAP_ADDRH = EE_address / 256;       //é€æ‰‡åŒºåœ°å€é«˜å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€å
             -œ°å€ï¼‰
  56   1          IAP_ADDRL = EE_address % 256;       //é€æ‰‡åŒºåœ°å€ä½å­—èŠ‚
  57   1          eeprom_trig();                      //è§¦å‘EEPROMæ“ä½œ
  58   1          eeprom_disable();                    //ç¦æ­¢EEPROMæ“ä½œ
  59   1      }
  60          
  61          //========================================================================
  62          // æè¿°: è¯»Nä¸ªå­—èŠ‚å‡½æ•°.
  63          // å‚æ•°: EE_address:  è¦è¯»å‡ºçš„EEPROMçš„é¦–åœ°å€.
  64          //       DataAddress: è¦è¯»å‡ºæ•°æ®çš„æŒ‡é’ˆ.
  65          //       length:      è¦è¯»å‡ºçš„é•¿åº¦
  66          // è¿”å›: 0: å†™å…¥æ­£ç¡®.  1: å†™å…¥é•¿åº¦ä¸º0é”™è¯¯.  2: å†™å…¥æ•°æ®é”™è¯¯.
  67          //========================================================================
  68          void eeprom_read(uint16 EE_address,uint8 *DataAddress,uint8 length)
  69          {
  70   1          EEPROM_IAP_ENABLE();                           //è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œå…è®¸IAPæ“ä½œï¼Œé€ä¸€æ¬¡å°±å¤
             -Ÿ
  71   1          EEPROM_IAP_READ();                             //é€å­—èŠ‚è¯»å‘½ä»¤ï¼Œå‘½ä»¤ä¸éœ€æ”¹å˜æ—¶ï¼Œä¸éœ€é‡
             -æ–°é€å‘½ä»¤
  72   1          do
  73   1          {
  74   2              IAP_ADDRH = EE_address / 256;       //é€åœ°å€é«˜å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€åœ°
             -å€ï¼‰
  75   2              IAP_ADDRL = EE_address % 256;       //é€åœ°å€ä½å­—èŠ‚
  76   2              eeprom_trig();                      //è§¦å‘EEPROMæ“ä½œ
  77   2              *DataAddress = IAP_DATA;            //è¯»å‡ºçš„æ•°æ®é€å¾€
  78   2              EE_address++;
  79   2              DataAddress++;
  80   2          }while(--length);
  81   1      
  82   1          eeprom_disable();
  83   1      }
  84          
  85          //========================================================================
  86          // æè¿°: å†™Nä¸ªå­—èŠ‚å‡½æ•°.
  87          // å‚æ•°: EE_address:  è¦å†™å…¥çš„EEPROMçš„é¦–åœ°å€.
  88          //       DataAddress: è¦å†™å…¥æ•°æ®çš„æŒ‡é’ˆ.
  89          //       length:      è¦å†™å…¥çš„é•¿åº¦
  90          // è¿”å›: 0: å†™å…¥æ­£ç¡®.  1: å†™å…¥é•¿åº¦ä¸º0é”™è¯¯.  2: å†™å…¥æ•°æ®é”™è¯¯.
  91          //========================================================================
  92          uint8 eeprom_write(uint16 EE_address,uint8 *DataAddress,uint8 length)
  93          {
  94   1          uint8  i;
  95   1          uint16 j;
  96   1          uint8  *p;
  97   1          
  98   1          if(length == 0) return 1;   //é•¿åº¦ä¸º0é”™è¯¯
  99   1      
 100   1          EEPROM_IAP_ENABLE();                       //è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œå…è®¸IAPæ“ä½œï¼Œé€ä¸€æ¬¡å°±å¤Ÿ
 101   1          i = length;
 102   1          j = EE_address;
 103   1          p = DataAddress;
 104   1          EEPROM_IAP_WRITE();                            //å®è°ƒç”¨, é€å­—èŠ‚å†™å‘½ä»¤
 105   1          do
 106   1          {
 107   2              IAP_ADDRH = EE_address / 256;       //é€åœ°å€é«˜å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€åœ°
             -å€ï¼‰
 108   2              IAP_ADDRL = EE_address % 256;       //é€åœ°å€ä½å­—èŠ‚
 109   2              IAP_DATA  = *DataAddress;           //é€æ•°æ®åˆ°IAP_DATAï¼Œåªæœ‰æ•°æ®æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€
C51 COMPILER V9.59.0.0   EEPROM                                                            02/08/2021 11:45:00 PAGE 3   

 110   2              eeprom_trig();                      //è§¦å‘EEPROMæ“ä½œ
 111   2              EE_address++;                       //ä¸‹ä¸€ä¸ªåœ°å€
 112   2              DataAddress++;                      //ä¸‹ä¸€ä¸ªæ•°æ®
 113   2          }while(--length);                       //ç›´åˆ°ç»“æŸ
 114   1      
 115   1          EE_address = j;
 116   1          length = i;
 117   1          DataAddress = p;
 118   1          i = 0;
 119   1          EEPROM_IAP_READ();                             //è¯»Nä¸ªå­—èŠ‚å¹¶æ¯”è¾ƒ
 120   1          do
 121   1          {
 122   2              IAP_ADDRH = EE_address / 256;       //é€åœ°å€é«˜å­—èŠ‚ï¼ˆåœ°å€éœ€è¦æ”¹å˜æ—¶æ‰éœ€é‡æ–°é€åœ°
             -å€ï¼‰
 123   2              IAP_ADDRL = EE_address % 256;       //é€åœ°å€ä½å­—èŠ‚
 124   2              eeprom_trig();                      //è§¦å‘EEPROMæ“ä½œ
 125   2              if(*DataAddress != IAP_DATA)        //è¯»å‡ºçš„æ•°æ®ä¸æºæ•°æ®æ¯”è¾ƒ
 126   2              {
 127   3                  i = 2;
 128   3                  break;
 129   3              }
 130   2              EE_address++;
 131   2              DataAddress++;
 132   2          }while(--length);
 133   1      
 134   1          eeprom_disable();
 135   1          return i;
 136   1      }
 137          
 138          //========================================================================
 139          // æè¿°: ä»EEPROMä¸­è¯»æµ®ç‚¹å‹æ•°æ®.
 140          // å‚æ•°: EE_address:è¦è¯»å–çš„åœ°å€.
 141          // è¿”å›: è¯»åˆ°çš„floatæ•°æ®.
 142          //========================================================================
 143          float eeprom_read_float(uint16 EE_address)
 144          {
 145   1        float dat;
 146   1        eeprom_read(EE_address,(uint8 *)&dat,sizeof(float));
 147   1        return dat;
 148   1      }
 149          
 150          //========================================================================
 151          // æè¿°: ä»EEPROMä¸­å†™æµ®ç‚¹å‹æ•°æ®.
 152          // å‚æ•°: EE_address:è¦è¯»å–çš„åœ°å€; dat:è¦å†™å…¥çš„floatæ•°æ®.
 153          // è¿”å›: none.
 154          //========================================================================
 155          void eeprom_write_float(uint16 EE_address, float dat)
 156          { 
 157   1        eeprom_write(EE_address,(uint8 *)&dat,sizeof(float));
 158   1      }
 159          
 160          //========================================================================
 161          // æè¿°: ä»EEPROMä¸­è¯»intæ•°æ®.
 162          // å‚æ•°: EE_address:è¦è¯»å–çš„åœ°å€.
 163          // è¿”å›: è¯»åˆ°çš„floatæ•°æ®.
 164          //========================================================================
 165          int eeprom_read_int(uint16 EE_address)
 166          {
 167   1        int dat;
 168   1        eeprom_read(EE_address,(uint8 *)&dat,sizeof(int));
 169   1        return dat;
 170   1      }
C51 COMPILER V9.59.0.0   EEPROM                                                            02/08/2021 11:45:00 PAGE 4   

 171          
 172          //========================================================================
 173          // æè¿°: ä»EEPROMä¸­å†™intæ•°æ®.
 174          // å‚æ•°: EE_address:è¦è¯»å–çš„åœ°å€; dat:è¦å†™å…¥çš„floatæ•°æ®.
 175          // è¿”å›: none.
 176          //========================================================================
 177          void eeprom_write_int(uint16 EE_address, int dat)
 178          { 
 179   1        eeprom_write(EE_address, (uint8 *)&dat,sizeof(int));
 180   1      }
 181          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    408    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      32
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
