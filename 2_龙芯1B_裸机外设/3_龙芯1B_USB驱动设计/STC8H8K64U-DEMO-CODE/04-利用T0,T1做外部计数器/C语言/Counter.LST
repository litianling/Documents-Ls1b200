C51 COMPILER V9.59.0.0   COUNTER                                                           03/15/2021 15:18:13 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE COUNTER
OBJECT MODULE PLACED IN Counter.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Counter.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /*---------------------------------------------------------------------*/
   2          /* --- STC MCU Limited ------------------------------------------------*/
   3          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
   4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
   5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
   6          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
   7          /* --- Web: www.STCMCU.com --------------------------------------------*/
   8          /* --- Web: www.STCMCUDATA.com  ---------------------------------------*/
   9          /* --- QQ:  800003751 -------------------------------------------------*/
  10          /* 如果要在程序中使用此代码,请在程序中注明使用了STC的资料及程序        */
  11          /*---------------------------------------------------------------------*/
  12          
  13          /*************  功能说明    **************
  14          
  15          本例程基于STC8H8K64U为主控芯片的实验箱8进行编写测试，STC8G、STC8H系列芯片可通用参考.
  16          
  17          用STC的MCU的IO方式驱动8位数码管。
  18          
  19          下载时, 选择时钟 24MHZ (用户可自行修改频率).
  20          
  21          显示效果为: 左边为T0(SW21)外部中断计数, 右边为T1(SW22)外部中断计数, 计数范围为0~255.
  22          
  23          由于按键是机械按键, 按下有抖动, 而本例程没有去抖动处理, 所以按一次有多个计数也是正常的.
  24          
  25          ******************************************/
  26          
  27          #include "reg51.h"       //包含此头文件后，里面声明的寄存器不需要再手动输入，避免重复定义
  28          
  29          #define     MAIN_Fosc       24000000UL  //定义主时钟
  30          
  31          typedef     unsigned char   u8;
  32          typedef     unsigned int    u16;
  33          typedef     unsigned long   u32;
  34          
  35          //手动输入声明"reg51.h"头文件里面没有定义的寄存器
  36          sfr P4   = 0xC0;
  37          sfr P5   = 0xC8;
  38          sfr P6   = 0xE8;
  39          sfr P7   = 0xF8;
  40          sfr P1M1 = 0x91;    //PxM1.n,PxM0.n     =00--->Standard,    01--->push-pull
  41          sfr P1M0 = 0x92;    //                  =10--->pure input,  11--->open drain
  42          sfr P0M1 = 0x93;
  43          sfr P0M0 = 0x94;
  44          sfr P2M1 = 0x95;
  45          sfr P2M0 = 0x96;
  46          sfr P3M1 = 0xB1;
  47          sfr P3M0 = 0xB2;
  48          sfr P4M1 = 0xB3;
  49          sfr P4M0 = 0xB4;
  50          sfr P5M1 = 0xC9;
  51          sfr P5M0 = 0xCA;
  52          sfr P6M1 = 0xCB;
  53          sfr P6M0 = 0xCC;
  54          sfr P7M1 = 0xE1;
  55          sfr P7M0 = 0xE2;
C51 COMPILER V9.59.0.0   COUNTER                                                           03/15/2021 15:18:13 PAGE 2   

  56          
  57          sbit P50 = P5^0;
  58          sbit P51 = P5^1;
  59          
  60          sfr INT_CLKO = 0x8F;
  61          
  62          sfr P_SW2 = 0xba;
  63          #define P3PU        (*(unsigned char volatile xdata *)0xfe13)
  64          
  65          /****************************** 用户定义宏 ***********************************/
  66          #define T0_CT 0x04
  67          #define T1_CT 0x40
  68          
  69          #define DIS_DOT     0x20
  70          #define DIS_BLACK   0x10
  71          #define DIS_        0x11
  72          
  73          /***************************** 本地常量声明 **********************************/
  74          u8 code t_display[]={                       //标准字库
  75          //   0    1    2    3    4    5    6    7    8    9    A    B    C    D    E    F
  76              0x3F,0x06,0x5B,0x4F,0x66,0x6D,0x7D,0x07,0x7F,0x6F,0x77,0x7C,0x39,0x5E,0x79,0x71,
  77          //black  -     H    J    K    L    N    o   P    U     t    G    Q    r   M    y
  78              0x00,0x40,0x76,0x1E,0x70,0x38,0x37,0x5C,0x73,0x3E,0x78,0x3d,0x67,0x50,0x37,0x6e,
  79              0xBF,0x86,0xDB,0xCF,0xE6,0xED,0xFD,0x87,0xFF,0xEF,0x46};    //0. 1. 2. 3. 4. 5. 6. 7. 8. 9. -1
  80          
  81          u8 code T_COM[]={0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80};      //位码
  82          
  83          /***************************** 本地变量声明 **********************************/
  84          u8  LED8[8];        //显示缓冲
  85          u8  display_index;  //显示位索引
  86          
  87          u8  T0_cnt, T1_cnt; //测试用的计数变量
  88          
  89          void delay_ms(u8 ms);
  90          void DisplayScan(void);
  91          
  92          //========================================================================
  93          // 函数: void timer0_int (void) interrupt TIMER0_VECTOR
  94          // 描述:  timer0中断函数.
  95          // 参数: none.
  96          // 返回: none.
  97          // 版本: V1.0, 2015-1-12
  98          //========================================================================
  99          void TM0_Isr() interrupt 1
 100          {
 101   1          P50 = !P50;  //测试端口
 102   1          T0_cnt++;    //计数+1
 103   1      }
 104          
 105          //========================================================================
 106          // 函数: void timer1_int (void) interrupt TIMER1_VECTOR
 107          // 描述:  timer1中断函数.
 108          // 参数: none.
 109          // 返回: none.
 110          // 版本: V1.0, 2015-1-12
 111          //========================================================================
 112          void TM1_Isr (void) interrupt 3
 113          {
 114   1          P51 = !P51;  //测试端口
 115   1          T1_cnt++;    //计数+1
 116   1      }
 117          
C51 COMPILER V9.59.0.0   COUNTER                                                           03/15/2021 15:18:13 PAGE 3   

 118          //========================================================================
 119          // 函数: void main(void)
 120          // 描述: 主函数.
 121          // 参数: none.
 122          // 返回: none.
 123          // 版本: V1.0, 2015-1-12
 124          //========================================================================
 125          void main()
 126          {
 127   1          u8 i;
 128   1          
 129   1          P0M1 = 0x00;   P0M0 = 0x00;   //设置为准双向口
 130   1          P1M1 = 0x00;   P1M0 = 0x00;   //设置为准双向口
 131   1          P2M1 = 0x00;   P2M0 = 0x00;   //设置为准双向口
 132   1          P4M1 = 0x00;   P4M0 = 0x00;   //设置为准双向口
 133   1          P5M1 = 0x00;   P5M0 = 0x00;   //设置为准双向口
 134   1          P6M1 = 0x00;   P6M0 = 0x00;   //设置为准双向口
 135   1          P7M1 = 0x00;   P7M0 = 0x00;   //设置为准双向口
 136   1          P3M1 = 0x30;   P3M0 = 0x00;  //P3.4,P3.5设置为输入口
 137   1      
 138   1          P_SW2 |= 0x80;
 139   1          P3PU = 0x30;            //P3.4,P3.5使能内部4.1K上拉电阻
 140   1          P_SW2 &= 0x7f;
 141   1      
 142   1          TMOD = 0;
 143   1          TMOD |= T0_CT;          //使能T0外部计数模式
 144   1          TMOD |= T1_CT;          //使能T1外部计数模式
 145   1          TL0 = 0xff;
 146   1          TH0 = 0xff;
 147   1          TL1 = 0xff;
 148   1          TH1 = 0xff;
 149   1          TR0 = 1;                //启动定时器T0
 150   1          TR1 = 1;                //启动定时器T1
 151   1          ET0 = 1;                //使能定时器中断T0
 152   1          ET1 = 1;                //使能定时器中断T1
 153   1      
 154   1          INT_CLKO &= ~0x03;      //T0,T1不输出时钟
 155   1      
 156   1          display_index = 0;
 157   1          for(i=0; i<8; i++)  LED8[i] = DIS_BLACK;    //全部消隐
 158   1          T0_cnt = 0;
 159   1          T1_cnt = 0;
 160   1      
 161   1          EA = 1;
 162   1      
 163   1          while(1)
 164   1          {
 165   2              delay_ms(1);    //延时1ms
 166   2              DisplayScan();
 167   2          }
 168   1      }
 169          
 170          //========================================================================
 171          // 函数: void delay_ms(u8 ms)
 172          // 描述: 延时函数。
 173          // 参数: ms,要延时的ms数, 这里只支持1~255ms. 自动适应主时钟.
 174          // 返回: none.
 175          // 版本: VER1.0
 176          // 日期: 2021-3-9
 177          // 备注: 
 178          //========================================================================
 179          void delay_ms(u8 ms)
C51 COMPILER V9.59.0.0   COUNTER                                                           03/15/2021 15:18:13 PAGE 4   

 180          {
 181   1           u16 i;
 182   1           do{
 183   2                i = MAIN_Fosc / 10000;
 184   2                while(--i);   //10T per loop
 185   2           }while(--ms);
 186   1      }
 187          
 188          /********************** 显示扫描函数 ************************/
 189          void DisplayScan(void)
 190          {   
 191   1          P7 = ~T_COM[7-display_index];
 192   1          P6 = ~t_display[LED8[display_index]];
 193   1          if(++display_index >= 8)
 194   1          {
 195   2              display_index = 0;  //8位结束回0
 196   2              LED8[0] = T0_cnt / 100;
 197   2              LED8[1] = (T0_cnt % 100)/10;
 198   2              LED8[2] = T0_cnt % 10;
 199   2              LED8[3] = DIS_BLACK;
 200   2              LED8[4] = DIS_BLACK;
 201   2              LED8[5] = T1_cnt / 100;
 202   2              LED8[6] = (T1_cnt % 100)/10;
 203   2              LED8[7] = T1_cnt % 10;
 204   2          }
 205   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    266    ----
   CONSTANT SIZE    =     51    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     11    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
